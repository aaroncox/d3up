$(function(){function e(e,t,n,r){t||(t=0);switch(n){case"per":t?t<=1?t=Math.round(t*1e3)/10+"%":t=Math.round(t*10)/10+"%":t="0%";break;case"round":t=Math.round(t*100)/100;default:}var i=e.replace(/\s+/g,"-").toLowerCase();t&&(t=t.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"));var s=$("<li/>").addClass("stat-"+i).html($("<span class='stat-helper'/>").html(e+": ")).append(t);return r&&(r<=1?s.append(" ("+Math.round(r*1e3)/10+"%)"):s.append(" ("+r+"%)")),s}function b(){g.init(),g.setPassives(v.val()),g.setClass($("#character").data("class")),g.setGear(".equipped a"),y=g.run(),w()}function w(){o.empty(),o.append($("<ul class='resist-specific'/>").append(e("EHP",y.ehp,"round"),e("EHP w/ Dodge",y["ehp-dodge"],"round"),e("EHP w/ Block",y["ehp-block"],"round"))),o.append($("<ul class='resist-specific'/>").append($("<li class='header'/>").html("VS Damage Source EHP"),e("Melee EHP",y["ehp-melee"],"round"),e("Ranged EHP",y["ehp-range"],"round"),e("Elite EHP",y["ehp-elite"],"round"))),o.append($("<ul class='resist-specific'/>").append($("<li class='header'/>").html("VS Specific Element EHP"),e("Physical EHP",y["ehp-physical"],"round"),e("Cold EHP",y["ehp-cold"],"round"),e("Fire EHP",y["ehp-fire"],"round"),e("Lightning EHP",y["ehp-lightning"],"round"),e("Poison EHP",y["ehp-poison"],"round"),e("Arcane/Holy EHP",y["ehp-arcane"],"round"))),r.empty(),r.append(e("Strength",y.strength)),r.append(e("Dexterity",y.dexterity)),r.append(e("Intelligence",y.intelligence)),r.append(e("Vitality",y.vitality)),r.append(e("Magic Find",y["plus-magic-find"],"per")),r.append(e("Gold Find",y["plus-gold-find"],"per")),n.empty(),n.append(e("Armor",y.armor,"round",y.armorReduce)),n.append(e("All Resist",y.allResist,"round",y["resper-all"])),n.append(e("Block Chance",y.blockChance,"per")),n.append(e("Dodge Chance",y.dodgePercent,"per")),n.append(e("Damage Reduction",y.armorReduction,"per")),n.append(e("Physical Resistance",y["resist-physical"],"round",y["resper-physical"])),n.append(e("Cold Resistance",y["resist-cold"],"round",y["resper-cold"])),n.append(e("Fire Resistance",y["resist-fire"],"round",y["resper-fire"])),n.append(e("Lightning Resistance",y["resist-lightning"],"round",y["resper-lightning"])),n.append(e("Poison Resistance",y["resist-poison"],"round",y["resper-poison"])),n.append(e("Arcane/Holy Resistance",y["resist-arcane"],"round",y["resper-arcane"])),n.append(e("Crowd Control Reduction",y["cc-reduce"]?y["cc-reduce"]:0,"per")),n.append(e("Missile Damage Reduction",y["range-reduce"],"per")),n.append(e("Melee Damage Reduction",y["melee-reduce"],"per")),n.append(e("Elite Damage Reduction",y["elite-reduce"],"per")),n.append(e("Thorns",y.thorns)),t.empty(),t.append(e("DPS",y.dps,"round")),t.append(e("Attacks per Second",y["dps-speedTotal"])),t.append(e("Critical Hit Chance",y["critical-hit"],"per")),t.append(e("Critical Hit Damage",y["critical-hit-damage"],"per")),i.empty(),i.append(e("Maximum Life",y.lifeTotal)),i.append(e("Total Life Bonus",y["plus-life"],"per")),i.append(e("Life per Second",y["life-regen"]?y["life-regen"]:0)),i.append(e("Life Steal",y["life-steal"]?y["life-steal"]:0,"per")),i.append(e("Life per Kill",y["life-kill"]?y["life-kill"]:0)),i.append(e("Life per Hit",y["life-hit"]?y["life-hit"]:0)),i.append(e("Health Globe Healing Bonus",y["health-globes"]?y["health-globes"]:0)),i.append(e("Bonus to Gold/Globe Radius",y["plus-pickup-radius"]?y["plus-pickup-radius"]:0));var s=$("<ul class='resist-specific'/>").append($("<li class='header'/>").html("Gear EHP Contributions (<a href='/faq/gear-based-ehp'>?</a>)"));s.append(e("Helm EHP",y["ehp-helm"],"round")),s.append(e("Shoulder EHP",y["ehp-shoulders"],"round")),s.append(e("Amulet EHP",y["ehp-amulet"],"round")),s.append(e("Chest EHP",y["ehp-chest"],"round")),s.append(e("Gloves EHP",y["ehp-gloves"],"round")),s.append(e("Bracers EHP",y["ehp-bracers"],"round")),s.append(e("Belt EHP",y["ehp-belt"],"round")),s.append(e("Pants EHP",y["ehp-pants"],"round")),s.append(e("Ring 1 EHP",y["ehp-ring1"],"round")),s.append(e("Ring 2 EHP",y["ehp-ring2"],"round")),s.append(e("Boots EHP",y["ehp-boots"],"round")),s.append(e("Main Hand EHP",y["ehp-mainhand"],"round")),s.append(e("Off Hand EHP",y["ehp-offhand"],"round")),$("#stats-ehp-gear").html(s);var u=$("<ul class='resist-specific'/>").append($("<li class='header'/>").html("Gear DPS Contributions (<a href='/faq/gear-based-dps'>?</a>)"));u.append(e("Helm DPS",y["dps-helm"],"round")),u.append(e("Shoulder DPS",y["dps-shoulders"],"round")),u.append(e("Amulet DPS",y["dps-amulet"],"round")),u.append(e("Chest DPS",y["dps-chest"],"round")),u.append(e("Gloves DPS",y["dps-gloves"],"round")),u.append(e("Bracers DPS",y["dps-bracers"],"round")),u.append(e("Belt DPS",y["dps-belt"],"round")),u.append(e("Pants DPS",y["dps-pants"],"round")),u.append(e("Ring 1 DPS",y["dps-ring1"],"round")),u.append(e("Ring 2 DPS",y["dps-ring2"],"round")),u.append(e("Boots DPS",y["dps-boots"],"round")),$("#stats-dps-gear").html(u)}function M(e,t,n,r){var i=jQuery.extend({},e),s=g.getItem(n),o=null,u=[];g.init(),g.setClass($("#character").data("class")),g.setGear(".equipped a"),g.setPassives(activePassives),g.removeItem(n);switch(t.type){case"2h-mace":case"2h-axe":case"diabo":case"2h-mighty":case"polearm":case"staff":case"2h-sword":$("#equipped-offhand a").length&&(o=JSON.parse($("#equipped-offhand a").attr("data-json")),g.removeItem("offhand"),u.push("We notice you're comparing a two-handed weapon vs your currently equipped mainhand + off-hand items. We've adjusted the comparision slightly so you can see the actual stats between your mainhand + offhand VS the two-hander (without the offhand)."))}g.parseItem(t,n);var a=g.run(),f=g.diff(i,a);$(".compare-diff").empty();if(!r){var l=$("<h4>Comparision Results</h4>").css({margin:0}),c=$("<p/>").append("Old Item: ",g.getItemLink(s)),h=$("<p/>").append("New Item: ",g.getItemLink(t));o&&c.append(" + Offhand: ",g.getItemLink(o))}$(".compare-diff").append(l,c,h),$("#compare-notes").html(""),u.length>0&&$.each(u,function(e,t){$("#compare-notes").append(t)});var p=$("<table/>");header=$("<tr/>").append("<th>Stat</th><th>Diff</th><th>Old</th><th>New</th>"),p.append(header),$.each(f,function(e,t){var n=t.split("|"),r=n[1],s=n[0],o=$("<tr/>");o.append($("<td/>").html(s));var u=Math.round(i[e]*100)/100,f=Math.round(a[e]*100)/100;u>99999&&(u=Math.round(u/10)/100+"k"),f>99999&&(f=Math.round(f/10)/100+"k"),r>0?(o.append($("<td/>").html("+"+r).addClass("pos")),o.append($("<td class='neg'/>").html(u)),o.append($("<td class='pos'/>").html(f))):(o.append($("<td/>").html(r).addClass("neg")),o.append($("<td class='pos'/>").html(u)),o.append($("<td class='neg'/>").html(f))),p.append(o)}),p.append("<tr><td colspan='10'><span class='pos'>Green = Increase</span> / <span class='neg'>Red = Decrease</span></td></tr>"),$(".compare-diff").append(p)}var t=$("#stats-offense"),n=$("#stats-defense"),r=$("#stats-base"),i=$("#stats-life"),s=$("#stats-misc"),o=$("#stats-ehp"),u=$("#stats-ehp-gear"),a=$("#stats-dps-gear"),f=$("#vsLevel"),l=$("#character").data("class"),c=$("#character").data("owner"),h=$("#skill-display"),p=$("#actives"),d=$("#active-display"),v=$("#passives"),m=$("#passive-display"),g=Object.create(buildCalculator);g.init(),g.setClass($("#character").data("class")),g.setGear(".equipped a"),g.setPassives(activePassives);var y=g.run();activeSkills&&activeSkills[l]&&$.each(window.activeSkills[l],function(e,t){var n="";typeof activeActives!="undefined"&&$.each(activeActives,function(t,r){e==r&&(n='selected="selected"')}),p.append($("<option value='"+e+"' "+n+"/>").html(t.name))}),passives&&passives[l]&&$.each(passives[l],function(e,t){var n="";typeof activePassives!="undefined"&&$.each(activePassives,function(t,r){e==r&&(n='selected="selected"')}),v.append($("<option value='"+e+"' "+n+"/>").html(e.replace(/\-/g," ").capitalize()))}),p.chosen({placeholder:"Which skills/abilities do you use?",allowClear:!0}),v.chosen({placeholder:"Which passives skills are you using?",allowClear:!0}),p.bind("change",function(){var e=$(this).val()?$(this).val():[];(!e||activeActives.length!=e.length)&&c&&e.length<=6&&$.ajax({data:{a:"active-skills",actives:e}}),d.empty(),$.each(e,function(e,t){h.show();if(e>=6)return!1;var n=activeSkills[l][t],r=t.split("~"),i="/images/icons/"+l+"-"+r[0]+".png";img=$("<img/>").attr("src",i),img.attr("data-name",n.name),img.attr("title",n.name),n.rune?img.attr("data-tooltip",n.desc.replace(/  /,"<br/><br/>")+"<br/><br/>"+n.rune):img.attr("data-tooltip",n.desc),img.bindSkilltip(),d.append($("<li/>").html(img))}),b()}),v.bind("change",function(){var e=$(this).val()?$(this).val():[];(!e||activePassives.length!=e.length)&&c&&e.length<=3&&$.ajax({data:{a:"passive-skills",passives:e}}),m.empty(),$.each(e,function(e,t){h.show();var n=passives[l][t],r="/images/icons/"+l+"-"+t+".png";img=$("<img/>").attr("src",r),img.attr("data-name",t.replace(/\-/g," ").capitalize()),img.attr("title",t.replace(/\-/g," ").capitalize()),img.attr("data-tooltip",n.desc),img.bindSkilltip(),m.append($("<li/>").html(img))}),b()}),p.trigger("change"),v.trigger("change"),f.bind("change",function(){g.setVsLevel($(this).val()),b()}),c&&$(".gear-change").click(function(){var e=$(this).data("item-type"),t=$("#equipped-"+e);if(e=="offhand"){var n=$("#equipped-mainhand a").data("json");switch(n.type){case"2h-mace":case"2h-axe":case"diabo":case"2h-mighty":case"polearm":case"staff":case"2h-sword":return $($("<div style='padding: 20px'/>").html("<p>You're currently wearing a two handed weapon, an offhand isn't allowed.")).dialog({modal:!0,buttons:{Ok:function(){$(this).dialog("close")}}}),!1}}$.ajax({url:"/item/fetch/type/"+e,cache:!1,dataType:"json",success:function(n){var r=$("#available-gear"),i=$("#gear-change");r.html(""),r.append("<option value=''>Nothing</option>"),$.each(n,function(e,t){var n=$.parseJSON(t),i=$("<option/>");i.attr("value",e),i.attr("data-json",t),i.html(n.name),i.bindTooltip(),r.append(i)}),i.dialog({width:800,modal:!0,buttons:{Equip:function(){var n=$(this);$.ajax({data:{a:"equip",slot:e,newItem:r.val(),stats:{dps:y.dps,ehp:y.ehp}},success:function(e){if(r.val()!=""){var i=$("<a/>"),s=r.find(":selected"),o=$.parseJSON(s.attr("data-json"));switch(o.type){case"2h-mace":case"2h-axe":case"diabo":case"2h-mighty":case"polearm":case"staff":case"2h-sword":$("#equipped-offhand").html("Nothing")}i.attr("href","/i/"+r.val()),i.attr("data-json",JSON.stringify(o)),i.addClass("quality-"+o.quality),i.html(o.name),i.bindTooltip(),t.html(i)}else t.html("Nothing");n.dialog("close"),b()}})},Cancel:function(){$(this).dialog("close")}}})}})}),w(),$("#character").tabs({select:function(e,t){window.location=t.tab.href}}),$(".calc-stats").tabs(),$("#active-display, #passive-display").find("li img").each(function(){$(this).bindSkilltip()});var E=$("#compared-slot"),S=$("#compare-to");S.bind("change",function(){var e=$("#compared-slot").find(":selected").val(),t=$(this).find(":selected").data("json");M(y,t,e)}),E.bind("change",function(){var e=$(this).val();b(),$.ajax({url:"/item/fetch/type/"+e,cache:!1,dataType:"json",success:function(e){S.html(""),S.append("<option value=''>Nothing</option>"),$.each(e,function(e,t){var n=$.parseJSON(t),r=$("<option/>");r.attr("value",e),r.attr("data-json",t),r.html(n.name),r.bindTooltip(),S.append(r)})}})});var x=$("#simulate-slot"),T=!1,N=!1,C=!1,k=$("#simulate-stats"),L=$("#simulate-attributes"),A=$("#simulate-sliders"),O=!1;$("#simulation-stats").hide(),x.bind("change",function(){b(),O=jQuery.extend({},y),C=!1,T=$(this).val(),N=$("#equipped-"+T+" a").clone(),C=N.data("json"),N.bindTooltip(),k.find(".top p").empty().append(N),L.val(null);var e=k.find(".stats-primary .big-stat").empty(),t=k.find(".stats-primary .stat-helper").empty(),n=k.find(".stats-extra-percent").empty(),r=k.find(".stats-extra-range").empty();C.stats&&$.each(C.stats,function(i,s){var o=$("<input name='"+i+"' type='text'/>");o.val(s);switch(i){case"armor":e.html(o),t.html("Total Armor");break;case"block-chance":n.html(o).append(" Block Chance");break;case"dps":e.html("<span id='simulated-dps'>"+s+"</span>"),t.html("Damage Per Second");break;case"speed":n.html(o).append(" Attack Speed");break;case"damage":var u=$("<input name='"+i+"-min' type='text'/>"),a=$("<input name='"+i+"-max' type='text'/>");u.val(s.min),a.val(s.max);function f(){switch($(this).attr("name")){case"damage-min":C.stats.damage.min=$(this).val()?parseFloat($(this).val()):0;break;case"damage-max":C.stats.damage.max=$(this).val()?parseFloat($(this).val()):0;break;default:return console.log($(this)),!1}var e=(C.stats.damage.min+C.stats.damage.max)/2*C.stats.speed;$("#simulated-dps").html(Math.round(e*10)/10),g.init(),g.setClass($("#character").data("class")),g.setGear(".equipped a"),g.setPassives(activePassives),g.removeItem(T),g.parseItem(C,T),y=g.run(),M(O,C,T,!0),w()}u.bind("keyup",f),a.bind("keyup",f),r.append(u,"-",a).append(" Damage");break;default:console.log(i,s)}o.bind("keyup",function(){switch(i){case"block-chance":C.stats[$(this).attr("name")]=$(this).val()?parseFloat($(this).val())/100:0;break;default:C.stats[$(this).attr("name")]=$(this).val()?parseFloat($(this).val()):0;if(i=="speed"){var e=(C.stats.damage.min+C.stats.damage.max)/2*C.stats.speed;$("#simulated-dps").html(Math.round(e*10)/10)}}g.init(),g.setClass($("#character").data("class")),g.setGear(".equipped a"),g.setPassives(activePassives),g.removeItem(T),g.parseItem(C,T),y=g.run(),M(O,C,T,!0),w()})}),C.attrs&&$.each(C.attrs,function(e,t){L.find("option[value="+e+"]").attr("selected","selected")}),$("#simulate-stats ul.stats").empty(),L.trigger("liszt:updated"),L.trigger("change"),$("#simulation-stats").show()}),L.bind("change",function(){var e=$(this).val(),t=$("#simulate-stats ul.attrs");e&&$.each(e,function(e,n){if(n!=""){var r=t.find("."+n);if(td[n]&&!r.length){var i=C.attrs[n]?C.attrs[n]:0,s=$("<li></li>"),o=td[n],u="<input type='text' name='"+n+"' value='"+i+"' tabindex='100'/>";o=o.replace("VVV",u),s.append(o),s.find("input").bind("keyup",function(){C.attrs[$(this).attr("name")]=$(this).val()?$(this).val():0,g.init(),g.setClass($("#character").data("class")),g.setGear(".equipped a"),g.setPassives(activePassives),g.removeItem(T),g.parseItem(C,T),y=g.run(),M(O,C,T,!0),w()}),s.addClass(n),t.append(s)}}}),t.find("li").each(function(){if(!e||e.indexOf($(this).attr("class"))==-1)C.attrs[$(this).attr("class")]=0,g.init(),g.setClass($("#character").data("class")),g.setGear(".equipped a"),g.setPassives(activePassives),g.removeItem(T),g.parseItem(C,T),y=g.run(),M(O,C,T,!0),w(),$(this).remove()})}),L.chosen()})