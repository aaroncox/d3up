<?
	$profile = Epic_Auth::getInstance()->getProfile();
	$this->headTitle($this->record->name); 
	$this->headTitle(ucwords(str_replace("-", " ", $this->record->class))); 
	$myBuild = false;
	if($profile && $this->record->_createdBy && $profile->createReference() == $this->record->_createdBy->createReference()) {
		$myBuild = true;
	}
	
?>
<style type="text/css">
	#gear-change {
		display: none;
	}
	#character {
		width: 550px;
	}
	#compare-notes {
		list-style: none;
		padding: 15px;
		margin: 0;
		color: #F00;
	}
	.equipment-table {
	}
	.equipment-table td {
		padding: 5px;
		vertical-align: middle;
		width: 70px;
	}
	.equipment-table td.primary {
		width: auto;
	}
	.calc-stats ul {
		list-style: none;
		margin: 0 0 10px;
		padding: 0;
	}
	.compare-diff {
		padding: 10px;
		font-size: 0.9em;
	}
	.compare-diff table {
		width: 99%;
		margin: 10px 0;
	}
	.compare-diff table th {
		font-size: 1.1em;
	}
	.compare-diff table tr:first-child {
		border-top: 1px solid #555;		
	}
	.compare-diff table tr {
		border-bottom: 1px solid #555;
	}
	.compare-diff table th,
	.compare-diff table td {
		padding: 2px 5px;
		text-align: center;
	}
	.compare-diff table th:first-child,
	.compare-diff table td:first-child {
		text-align: right;
	}
	.compare-diff .pos {
		color: #0F0;
	}
	.compare-diff .neg {
		color: #F00;
	}
	.stat-ehp, 
	.stat-dps {
		font-size: 24px;
		font-weight: bold;
		margin: 0 0 10px;
	}
	.build-header {
		margin: 5px 0;
		padding: 5px 20px;
	}
	.build-header h2 {
		color: #7FCDFF;
		margin: 5px 0;
	}
	.build-header .controls {
		float: right;
		padding: 5px;
	}
	.comment {
		margin: 15px 0;
	}
	.comment .comment-body {
		padding: 3px 15px;
		background-color: #333;
	}
	.comment .comment-author {
		font-size: 1.2em;
		font-weight: bold;
		color: #7FCDFF;
	}
	.comment.reply .comment-author {
		font-size: 1.0em;
	}
	.comment .comment-buttons {
		color: #ccc;
		background-color: #333;
		font-weight: bold;
		text-align: right;
	}
	.comment .comment-buttons a {
		cursor: pointer;
		margin: 0 5px;
	}
	.comment.reply {
		margin-left: 30px;
	}
	.comment .comment-expand {
		text-align: center;
		background-color: #333;
		font-weight: bold;
		color: #7FCDFF;
		margin-top: 5px;
	}
	.comment #source-label,
	#replyTo-label,
	#replyTo-element,
	#referrer-element, 
	#referrer-label {
		display: none;
	}
</style>
<div class="build-header ui-widget ui-widget-content ui-corner-all">
	<? if($profile && $this->record->_createdBy): ?>
	<div class="controls">
		<? if($profile->createReference() == $this->record->_createdBy->createReference()): ?>
			<a href="/b/<?= $this->record->id ?>/edit" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only gear-change"><span class="ui-button-text">Edit</span></a>			
		<? else: ?>
			<a href="/b/<?= $this->record->id ?>/copy" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only gear-change"><span class="ui-button-text">Copy this Build</span></a>
		<? endif; ?>
	</div>
	<? endif; ?>
	<h2>
		<?= $this->record->name ?> (<?= ucwords(str_replace("-", " ", $this->record->class)) ?>)
	</h2>
	<? if($this->record->_original->id): ?>
		<p>Based on the original build: <a href="/b/<?= $this->record->_original->id ?>"><?= $this->record->_original->name ?> (<?= ucwords(str_replace("-", " ", $this->record->_original->class)) ?>)</a></p>
	<? endif; ?>
	<? if($this->record->description): ?>
		<p><?= $this->record->description ?></p>
	<? endif ?>
</div>
<div id="character" class="inline-flow" data-class="<?= $this->record->class ?>">
	<ul>
		<li><a href="#build-gear">Gear</a></li>
		<li><a href="#build-skills">Skills</a></li>
		<? if($myBuild): ?>
			<li><a href="#build-compare">Compare</a></li>
		<? endif ?>
		<? if($this->record->guideIsPublished || $myBuild): ?>
			<li><a href="#build-guide">Guide</a></li>
		<? endif ?>
		<? if($this->comments): ?>
			<li><a href="#build-comments">Comments (<?= $this->comments->getTotalItemCount()?>)</a></li>
		<? endif ?>
	</ul>
	<div id="build-skills">
		<script type="text/javascript">
			<? if($this->record->passives && $this->record->passives != "null" && count($this->record->passives)): ?>
				var activePassives = <?= json_encode($this->record->passives->export()); ?>
			<? else: ?>
				var activePassives = [];
			<? endif; ?>
		</script>
		<? if($myBuild): ?>
			<p>Please select the 3 passive skills you're using:</p>
		<? else: ?>
			<p style="color: #c80000">Note: You can use this to toggle passives on and off, but it will not save.</p>
		<? endif; ?>
		<select id="passives" multiple="multiple" name="passives[]" style="width: 450px"></select>
		<ul id="passive-display">
			<li>No Passives Detected</li>
		</ul>
	</div>
	<? if($this->record->guide || $myBuild): ?>
		<div id="build-guide">
			<? if($myBuild): ?>
				<p>You may build a guide to help explain this build using the textbox below. Guides may be created using <a href="http://en.wikipedia.org/wiki/Markdown#Syntax_examples">Markdown Syntax</a> and limited HTML tags similar to sites such as <a href="http://reddit.com">Reddit</a>.</p>
				<p><strong>NOTE:</strong> The GUIDE tab on your build will not be publicly available until you check the "Publish" checkbox and hit save at the bottom of the form.</p>
				<?= $this->guideForm ?>
				<p>Shown below is how your guide appears:</p>
				<hr/>
			<? endif ?>
			<? if($this->record->guide && $this->record->guideIsPublished): ?>
				<?= $this->record->guide ?>
			<? endif ?>
		</div>
	<? endif ?>
	<? if($myBuild): ?>
	<div id="build-compare">
		<p>This compare tool will compare what you are <b>currently wearing</b> to an item you select from the database.</p>
		<p>Please select the <i>slot</i> of the item you wish to compare first, then select the item from your items from the drop down or type the ID # of the item in the text box next to it.</p>
		<p>Which item slot should we compare?</p>
		<select id="compared-slot">
			<option></option>
			<? foreach($this->record->equipment->getSlots() as $slot): ?>
				<option class="slot" value="<?= $slot ?>"><?= ucfirst($slot) ?></option>
			<? endforeach; ?>
		</select>
		<span id="compared-to"></span>
		<p>And what should we compare it to?</p>
		My Items: 
		<select id="compare-to">
		</select>
		<!-- or
		<input type="text" id="compare-to-id" style="width: 50px"/> (Enter Item ID) -->
		<ul id="compare-notes"></ul>
		<div class="compare-diff">
		</div>
		<p><b>Note</b>: Currently the item HAS to be created by you before you are able to compare them.</p>
	</div>
	<? endif; ?>
	<div id="build-gear">
		<? if($myBuild): ?>
		<p>Adding gear to your build will dynamically update the statistics displayed in the statistics panel.</p>
		<p>
			<a href="/item/create" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only gear-change"><span class="ui-button-text">Create New Item</span></a>
			<a href="/user/items" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only gear-change"><span class="ui-button-text">View My Items</span></a>
		</p>
		<? endif; ?>
		<table class="equipment-table">
		<? foreach($this->record->equipment->getSlots() as $slot): ?>
			<tr>
				<td>
					<?= ucfirst($slot) ?>
				</td>
				<? if($myBuild): ?>
				<td>
					<button id="change-<?= $slot ?>" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only gear-change" data-item-type="<?= $slot ?>" role="button" aria-disabled="false"><span class="ui-button-text">Change</span></button>
				</td>
				<? endif; ?>
				<td class="primary">
					<span class="equipped" id="equipped-<?= $slot ?>" data-slot="<?= $slot ?>">
						<? if($this->record->equipment[$slot]->id): ?>
							<?= $this->itemLink($this->record->equipment[$slot]) ?>
						<? else: ?>
							Nothing
						<? endif ?>
					</span>
				</td>
			</tr>
		<? endforeach ?>
		</table>
	</div>
	<? if($this->comments): ?>
	<div id="build-comments" style="display: none">
		<?= $this->commentForm ?>
		<hr/>
		<? foreach($this->comments as $comment): ?>
			<div class='comment' id="comment-<?= $comment->id ?>" data-comment="<?= $comment->id ?>">
				<div class='comment-meta'>
					<span class='comment-author'><?= $comment->profile->username?:'Anonymous' ?></span> - 
					<span class='comment-time'>
						<?= $this->timeAgo($comment->_created) ?>
					</span>
				</div>
				<div class='comment-body'>
					<?= $comment->body ?>
				</div>
				<div class='comment-buttons'>
					<a href="#">permalink</a>
					<a class='comment-reply'>reply</a>
				</div>
				<div class='comment-extra'></div>
				<div class="comment-replies">
				<? foreach($comment->getReplies() as $reply): ?>
					<div class='comment reply' id="comment-<?= $reply->id ?>" data-comment="<?= $reply->id ?>">
						<div class='comment-meta'>
							<span class='comment-author'><?= $comment->profile->username?:'Anonymous' ?></span> - 
							<span class='comment-time'>
								<?= $this->timeAgo($reply->_created) ?>
							</span>
						</div>
						<div class='comment-body'>
							<?= $reply->body ?>
						</div>
					</div>
				<? endforeach ?>
				</div>
			</div>
		<? endforeach ?>
	</div>
	<? endif; ?>
</div>
<div class="inline-flow" style="width: 396px">
	<div class="calc-stats ui-widget ui-widget-content ui-corner-all">
		<ul>
			<li><a href="#tab-base">Stats</a></li>
			<li><a href="#tab-dps">DPS</a></li>
			<li><a href="#tab-ehp">EHP</a></li>
		</ul>
		<div style="background-image: none; padding: 15px 15px 0">
			<select id="vsLevel">
				<option value="60">Stats vs Level 60 Monster</option>
				<option value="61">Stats vs Level 61 Monster</option>
				<option value="62">Stats vs Level 62 Monster</option>
				<option value="63" selected="selected">Stats vs Level 63 Monster</option>
			</select>
		</div>
		<div id="tab-base">
			<ul id="stats-offense"><li>Damage</li></ul>
			<ul id="stats-base"><li>base</li></ul>
			<ul id="stats-life"><li>life</li></ul>
			<ul id="stats-defense"><li>armor</li></ul>
			<ul id="stats-misc"></ul>
		</div>
		<div id="tab-dps">
			Coming Soon
		</div>
		<div id="tab-ehp">
			<ul id="stats-ehp"><li>test</li></ul>
		</div>
	</div>
</div>
<div id="gear-change" title="Select an Item">
	<p>Listed below are all of the items you've created that would fit into this equipment slot.</p>
	<p>Please choose which item you'd like to equip.</p>
	<fieldset>
		<select name="available" id="available-gear" class="ui-widget-content ui-corner-all">
		</select>
	</fieldset>
	</form>
</div>
<script type="text/javascript" src="/js/calc.js"></script>
<script type="text/javascript">
$("#character").tabs({
    select: function(event, ui){
      window.location = ui.tab.href;
    }
});
$(".calc-stats").tabs();
$(".comment").each(function() {
	var $this = $(this), 
			comment = $this.data("comment");
	$this.find(".comment-replies").each(function() {
		var replies = $(this), 
				count = 0;
		count = $(this).find(".comment.reply").length;
		replies.hide();
		if(count) {
			var expander = $("<div class='comment-expand'>").html("Show " + count + " Replies");
			expander.bind('click', function() {
				replies.show();
				$(this).hide();
			});
			$(this).after(expander);			
		}
	});
	$(this).find("a.comment-reply").bind('click', function() {
		$.ajax({
			url: '/c/'+comment+'/reply',
			type: 'json',
			success: function(data) {
				var json = $.parseJSON(data),
						form = json.form;
				$this.find('.comment-extra').empty().append(form);				
			}
		});
	});
});
</script>