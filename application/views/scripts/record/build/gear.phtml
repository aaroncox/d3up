<h5>Gear / Items</h5>
<? if($this->myBuild): ?>
  <a class="button show-gear-change"><span class="ui-button-text">Change Gear</span></a>
<? endif ?>
<div class="page">
  <table class="equipment-table">
    <thead>
      <tr>
        <td>&nbsp;</td>
        <td colspan="2" style="text-align: center">
          <select id="gear-stats">
            <option value="contributions">EHP/DPS Contributions</option>
            <option value="stats">Gear Stats / Perfection</option>
            <? if($this->myBuild): ?><option value="gear-controls">Controls</option><? endif ?>
          </select>
        </td>
      </tr>
      <tr>
        <th>Name</th>
        <? if($this->myBuild): ?>
        <th class="cell-header gear-controls" colspan="2">Controls</th>
        <? endif ?>
        <th class="cell-header contributions">DPS<br/>(% of Total)</th>
        <th class="cell-header contributions">EHP<br/>(% of Total)</th>
        <th class="cell-header stats">Gear Stats</th>
        <th class="cell-header stats">Perfection</th>
      </tr>
    </thead>
    <tbody>
      <? foreach($this->record->equipment->getSlots() as $slot): ?>
      	<tr>
      		<td class="primary">
      			<span class="equipped" id="equipped-<?= $slot ?>" data-slot="<?= $slot ?>">
      				<? if($this->record->equipment[$slot]->id): ?>
      					<?= $this->itemLink($this->record->equipment[$slot]) ?>
      				<? else: ?>
      					Nothing
      				<? endif ?>
      			</span>
      			<br/><span class="equipped-type"><?= ucfirst($slot) ?></span>
      		</td>
      		<? if($this->myBuild): ?>
          <td class="cell-data gear-controls">
            <a id="change-<?= $slot ?>" class="button gear-change" data-item-type="<?= $slot ?>" role="button" aria-disabled="false"><span class="ui-button-text">Change</span></button>
          </td>
          <td class="cell-data gear-controls">
            <a id="new-<?= $slot ?>" class="button" href="/item/create?b=<?= $this->record->id ?>&slot=<?= $slot ?>&return=build"><span class="ui-button-text">New Item</span></a>
          </td>
          <? endif ?>
          <td class="cell-data contributions" id="gear-dps-<?= $slot ?>">~</td>
          <td class="cell-data contributions" id="gear-ehp-<?= $slot ?>">~</td>
          <td class="cell-data stats" colspan="2">
            <? 
              $total = count($this->record->equipment[$slot]->attrs);
              $count = 1;
              $max = D3Up_Tool_MaxStat::getInstance();
            ?>
            <? if($total): ?>
              <table class="d3up-table perfection-table">
              <? foreach($this->record->equipment[$slot]->attrs as $attr => $val):?> 
                <? if(is_object($val)): ?>
                  <? $val = implode("-", $val->export()) ?>
                <? endif ?>
                <? if($this->shortStat($val, $attr)): ?>
                <tr class='item-rating item-rating-<?= $attr ?> item-rating-filter' data-attr="<?= $attr ?>">
                  <td><?= $this->shortStat(null, $attr) ?></td>
                  <td><?= $val ?></td>
                  <td>
                    <?= $max->calcStat($attr, $val, $this->record->equipment[$slot]->type) ?>
                  </td>
                </tr>
                <?
                  $rating = $max->calcStat($attr, $val, $this->record->equipment[$slot]->type, true);
                ?>
                  <? if(isset($rating['rating'])): ?>
                  <tr class='item-rating item-rating-<?= $attr ?> item-rating-filter' data-attr="<?= $attr ?>">
                    <td colspan='3'>
                      <div class='rating-bar' data-percent="<?= $rating['rating'] ?>" style='width: <?= $rating['rating'] ?>%; height: 3px;'></div>
                    </td>
                  </tr>
                  <? else: ?>
                  <tr class='item-rating item-rating-<?= $attr ?>'>
                    <td colspan='3'>
                      <div class='rating-bar' data-percent="<?= $rating['rating'] ?>" style='width: <?= $rating['rating'] ?>%; height: 3px;'></div>
                    </td>
                  </tr>
                  <? endif ?>
                <? endif ?>
                <? $count++ ?>
              <? endforeach ?>
              </table>
            <? endif ?>
          </td>
      	</tr>
      <? endforeach ?>
    </tbody>
  </table>
  <script type="text/javascript" charset="utf-8">
    $(function() {
      var selector = $("#gear-stats"),
          table = $(".equipment-table"),
          cellHeader = $(".cell-header"),
          cellData = $(".cell-data"),
          gearChange = $(".show-gear-change");
      gearChange.click(function() {
        selector.find("option").removeAttr("selected");
        selector.find("option[value=gear-controls]").attr("selected", "selected");
        selector.trigger("change");
      });
      cellData.hide();
      cellHeader.hide();
      table.find(".contributions").show();
      selector.bind('change', function() {
        cellData.hide();
        cellHeader.hide();
        table.find("." + $(this).val()).show();
      });
      var itemRatings = $("tr.item-rating"),
          toggle = false;
      $(".item-rating-filter").bind('click', function() {
        if(toggle == false) {
          var attr = $(this).data("attr");
          itemRatings.hide();
          $("tr.item-rating-" + attr).show();
          toggle = true;          
        } else {
          $("tr.item-rating").show();
          toggle = false;
        }
      }).css({cursor: 'pointer'});
      $( ".rating-bar" ).each(function() { var elem = $(this), percent = elem.data("percent") / 100; if (percent>1) { elem.css("background-color", "white"); } else { elem.css("background-color", $.Color( "red" ).lightness(0.5).transition($.Color( "green" ).lightness(0.5), percent)); } });    
    });
  </script>
</div>